# 客户端登录逻辑

---

### 请求

```json
http://106.75.230.157:8080/msg_server
```

```http
GET /msg_server HTTP/1.1
Host: 106.75.230.157:8080
Connection: keep-alive
Accept: */*;
```

### 响应

```json
HTTP/1.1 200 OK
Connection:close
Content-Length:273
Content-Type:text/html;charset=utf-8
{
   "backupIP" : "106.75.230.157",
   "code" : 0,
   "discovery" : "http://106.75.230.157/api/discovery",
   "msfsBackup" : "http://106.75.230.157:8700/",
   "msfsPrior" : "http://106.75.230.157:8700/",
   "msg" : "",
   "port" : "8000",
   "priorIP" : "106.75.230.157"
}
```

### 客户端登录流程

1. LoginDialog::OnClick()点击登录按钮后调用LoginDialog::_DoLogin()，生产连接登录服务器请求msg ip信息的操作任务DoLoginServerHttpOperation() ，该任务设置任务完成的回调OnHttpCallbackOperation()后放入http任务队列中
2. http任务线程从http任务队列中取出该http请求任务任务，执行该任务的processOpertion()进行http请求，并解析出返回的json结果，并给代理窗口发送事件消息，通知代理窗口进行执行之前注册的回调函数OnHttpCallbackOperation
3. 代理窗口线程调用OnHttpCallbackOperation()，并生产LoginOperation操作任务，设置任务完成回调OnOperationCalllback()
4. 逻辑任务队列取出该任务，执行该任务的processOpertion()，进行连接消息服务器 module::getTcpClientModule()->doLogin()
5. 在doLogin中连接消息服务器，等待5s超时建立连接，然后进行登录请求，在此等待10s，有回应则返回
6. 将回应的数据解析出来，并创建自己的信息
7. 通知代理窗口线程调用OnPoerationCallback(),进行登录成功和登录失败的一系列处理



### 服务端登录流程

1. 登录服务端netlib_listen(cal, cal_data)设置回调函数m_calback
2. 初始化该socket并设置状态为SOCKET_STATE_LISTENING
3. 当有客户端连接时，CBaseSocket::OnRead()中检测到该socket状态为监听状态，则调用_AcceptNewSocket()，否则调用m_callback()
4. 对于处于监听状态的socket，将 接受的新连接置于已连接状态，并加入到全局map中管理，并将新的socket加入事件分发器中监听读事件，且调用之前设置的回调函数m_callback()
5. m_callback()调用CHttpConn::OnConnect(handle)，新建CHttpConn连接实例，加入到全局conn_map中管理，并设置会话类回调httpConn_callback()
6. 对于已连接状态的socket，调用建立连接时设置的回调函数httpConn_callback()
7. 调用会话类中的读写反应函数
8. CHttpConn::OnRead()是请求msg服务器ip，则调用_HandleMsgServRequest，将msg服务器ip信息，封装成json格式数据发送出去，数据不能发送出去先放缓冲区，发送完成调用OnWriteComlete（），进行关闭http连接
9. 客户端获取到msg信息后，发送登录包给msg
10. msg处理链接流程与上同，在处理消息时，先解析，再与数据库做比对，再回应客户端
